<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ü‡¶æ‡¶á‡¶™‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶´‡¶ø ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d0d14;--panel:#161622;--panel2:#1e1e2e;--border:rgba(255,255,255,0.07);
  --accent:#f0a500;--accent2:#e05c5c;--blue:#4e9eff;--green:#4ecca3;
  --text:#e8e8f4;--muted:#6b6b88;--input:#0a0a12;
}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{background:var(--panel);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:16px;flex-shrink:0;z-index:100}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;white-space:nowrap}
.logo span{font-size:0.75rem;font-weight:400;-webkit-text-fill-color:var(--muted);display:block;margin-top:-4px}
header .actions{margin-left:auto;display:flex;gap:8px}
.btn{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;font-size:0.82rem;font-family:'DM Sans',sans-serif;font-weight:500;transition:all .2s}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{background:#ffc107;transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-outline:hover{background:var(--panel2);border-color:var(--accent)}
.btn-danger{background:rgba(224,92,92,0.15);color:var(--accent2);border:1px solid rgba(224,92,92,0.3)}
.btn-danger:hover{background:rgba(224,92,92,0.25)}
.btn-sm{padding:5px 12px;font-size:0.75rem}
.btn-green{background:rgba(78,204,163,0.15);color:var(--green);border:1px solid rgba(78,204,163,0.3)}
.btn-green:hover{background:rgba(78,204,163,0.25)}

main{display:flex;flex:1;overflow:hidden}

/* LEFT PANEL */
.left-panel{width:280px;min-width:280px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.panel-section{padding:14px;border-bottom:1px solid var(--border)}
.section-title{font-size:0.68rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:10px;font-weight:600}
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--input)}
.upload-zone:hover{border-color:var(--accent);background:rgba(240,165,0,0.05)}
.upload-zone input{display:none}
.upload-zone .icon{font-size:2rem;margin-bottom:6px}
.upload-zone p{font-size:0.78rem;color:var(--muted)}
label.field-label{font-size:0.72rem;color:var(--muted);display:block;margin-bottom:4px;margin-top:10px}
label.field-label:first-child{margin-top:0}
input[type=text],input[type=number],select,textarea{width:100%;background:var(--input);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:7px 10px;font-size:0.82rem;font-family:'DM Sans',sans-serif;outline:none;transition:border .2s}
input[type=text]:focus,input[type=number]:focus,select:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:60px}
select option{background:var(--panel2)}
.color-row{display:flex;gap:8px;align-items:center}
.color-row input[type=color]{width:36px;height:32px;border:1px solid var(--border);border-radius:6px;background:none;cursor:pointer;padding:2px}
.color-row input[type=text]{flex:1}
.range-row{display:flex;gap:8px;align-items:center}
.range-row input[type=range]{flex:1;accent-color:var(--accent)}
.range-row span{font-size:0.72rem;color:var(--muted);min-width:30px;text-align:right}
.toggle-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.toggle-btn{padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:var(--input);color:var(--muted);font-size:0.72rem;cursor:pointer;text-align:center;transition:all .2s}
.toggle-btn.active{background:rgba(240,165,0,0.15);border-color:var(--accent);color:var(--accent)}
.toggle-btn:hover:not(.active){border-color:rgba(255,255,255,0.2);color:var(--text)}

/* TEXT LAYERS */
.text-layers{padding:14px;border-bottom:1px solid var(--border)}
.layer-item{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s}
.layer-item.selected{border-color:var(--accent);background:rgba(240,165,0,0.08)}
.layer-item:hover{border-color:rgba(255,255,255,0.15)}
.layer-text{flex:1;font-size:0.8rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.layer-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;padding:2px 4px;border-radius:4px}
.layer-del:hover{color:var(--accent2);background:rgba(224,92,92,0.1)}

/* CANVAS AREA */
.canvas-area{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.canvas-toolbar{padding:10px 16px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-shrink:0}
.toolbar-label{font-size:0.72rem;color:var(--muted);margin-right:4px}
.canvas-wrapper{flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;padding:20px;position:relative}
#canvas-container{position:relative;display:inline-block;cursor:crosshair;user-select:none;box-shadow:0 20px 60px rgba(0,0,0,0.7)}
#base-canvas{display:block}
#overlay-canvas{position:absolute;top:0;left:0;pointer-events:none}
.text-handle{position:absolute;border:2px dashed rgba(240,165,0,0.7);border-radius:4px;cursor:move;padding:4px 8px;min-width:40px;min-height:30px;display:flex;align-items:center;justify-content:center;transition:border .15s;background:rgba(240,165,0,0.05)}
.text-handle.selected{border:2px solid var(--accent);background:rgba(240,165,0,0.1)}
.text-handle.selected .resize-handle{display:block}
.resize-handle{display:none;position:absolute;width:10px;height:10px;background:var(--accent);border-radius:2px;bottom:-5px;right:-5px;cursor:se-resize}

/* RIGHT PANEL */
.right-panel{width:240px;min-width:240px;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:999;display:none}
.loading-overlay.show{display:flex}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.preview-img{max-width:100%;border-radius:4px;display:block}
#preview-panel{padding:14px}
#preview-panel img{width:100%;border-radius:8px;margin-top:8px;border:1px solid var(--border)}
.hint{font-size:0.7rem;color:var(--muted);margin-top:6px;line-height:1.4}
.badge{display:inline-block;padding:2px 8px;border-radius:100px;font-size:0.65rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase}
.badge-green{background:rgba(78,204,163,0.15);color:var(--green);border:1px solid rgba(78,204,163,0.3)}
</style>
</head>
<body>

<header>
  <div class="logo">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ü‡¶æ‡¶á‡¶™‡ßã ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì <span>Bangla Typography Studio</span></div>
  <div class="actions">
    <button class="btn btn-outline btn-sm" onclick="resetCanvas()">üîÑ Reset</button>
    <button class="btn btn-green btn-sm" onclick="renderAndPreview()">üëÅ Preview</button>
    <button class="btn btn-primary btn-sm" onclick="downloadFinal()">‚¨á Download PNG</button>
  </div>
</header>

<main>
  <!-- LEFT PANEL -->
  <div class="left-panel">

    <div class="panel-section">
      <div class="section-title">üì∑ Upload Photo</div>
      <div class="upload-zone" onclick="document.getElementById('photo-input').click()">
        <input type="file" id="photo-input" accept="image/*" onchange="loadPhoto(event)">
        <div class="icon">üñº</div>
        <p>Click to upload your photo<br><small>JPG, PNG, WEBP</small></p>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">‚úç Add Bangla Text</div>
      <label class="field-label">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≤‡ßá‡¶ñ‡¶æ (Bangla Text)</label>
      <textarea id="new-text" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßã‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</textarea>
      <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addTextLayer()">+ Add Text Layer</button>
    </div>

    <div class="text-layers" id="layers-container">
      <div class="section-title">üìö Text Layers</div>
      <div id="layers-list"><p style="font-size:0.75rem;color:var(--muted)">No text layers yet</p></div>
    </div>

    <div class="panel-section">
      <div class="section-title">üé® Text Style</div>

      <label class="field-label">Font Family</label>
      <select id="font-select" onchange="updateSelected()">
        <option value="NotoSansBengali-Regular.ttf">Noto Sans Bengali Regular</option>
        <option value="NotoSansBengali-Bold.ttf">Noto Sans Bengali Bold</option>
        <option value="MuktaBangla-Regular.ttf">Mukta Bangla Regular</option>
        <option value="MuktaBangla-Bold.ttf">Mukta Bangla Bold</option>
        <option value="MuktaBangla-ExtraBold.ttf">Mukta Bangla ExtraBold</option>
        <option value="MuktaBangla-Light.ttf">Mukta Bangla Light</option>
      </select>

      <label class="field-label">Font Size</label>
      <div class="range-row">
        <input type="range" id="font-size" min="12" max="300" value="80" oninput="this.nextElementSibling.textContent=this.value;updateSelected()">
        <span>80</span>
      </div>

      <label class="field-label">Text Color</label>
      <div class="color-row">
        <input type="color" id="text-color" value="#ffffff" oninput="document.getElementById('text-color-hex').value=this.value;updateSelected()">
        <input type="text" id="text-color-hex" value="#ffffff" oninput="document.getElementById('text-color').value=this.value;updateSelected()">
      </div>

      <label class="field-label">Opacity</label>
      <div class="range-row">
        <input type="range" id="opacity" min="0" max="100" value="100" oninput="this.nextElementSibling.textContent=this.value+'%';updateSelected()">
        <span>100%</span>
      </div>

      <label class="field-label">Rotation (degrees)</label>
      <div class="range-row">
        <input type="range" id="rotation" min="-180" max="180" value="0" oninput="this.nextElementSibling.textContent=this.value+'¬∞';updateSelected()">
        <span>0¬∞</span>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">üñä Stroke / Outline</div>
      <label class="field-label">Stroke Width</label>
      <div class="range-row">
        <input type="range" id="stroke-width" min="0" max="30" value="0" oninput="this.nextElementSibling.textContent=this.value;updateSelected()">
        <span>0</span>
      </div>
      <label class="field-label">Stroke Color</label>
      <div class="color-row">
        <input type="color" id="stroke-color" value="#000000" oninput="document.getElementById('stroke-color-hex').value=this.value;updateSelected()">
        <input type="text" id="stroke-color-hex" value="#000000" oninput="document.getElementById('stroke-color').value=this.value;updateSelected()">
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">üåë Shadow</div>
      <label class="field-label">Shadow Blur</label>
      <div class="range-row">
        <input type="range" id="shadow-blur" min="0" max="40" value="8" oninput="this.nextElementSibling.textContent=this.value;updateSelected()">
        <span>8</span>
      </div>
      <label class="field-label">Shadow Color</label>
      <div class="color-row">
        <input type="color" id="shadow-color" value="#000000" oninput="document.getElementById('shadow-color-hex').value=this.value;updateSelected()">
        <input type="text" id="shadow-color-hex" value="#000000" oninput="document.getElementById('shadow-color').value=this.value;updateSelected()">
      </div>
      <label class="field-label">Shadow X / Y</label>
      <div style="display:flex;gap:6px">
        <input type="number" id="shadow-x" value="4" min="-50" max="50" style="width:50%" oninput="updateSelected()">
        <input type="number" id="shadow-y" value="4" min="-50" max="50" style="width:50%" oninput="updateSelected()">
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">‚ú® Special Effects</div>
      <div class="toggle-grid">
        <div class="toggle-btn" id="toggle-shadow" onclick="toggleEffect('shadow')">üåë Shadow</div>
        <div class="toggle-btn" id="toggle-glow" onclick="toggleEffect('glow')">üí° Glow</div>
        <div class="toggle-btn" id="toggle-neon" onclick="toggleEffect('neon')">üåà Neon</div>
        <div class="toggle-btn" id="toggle-outline" onclick="toggleEffect('outline')">‚¨ú Outline Only</div>
        <div class="toggle-btn" id="toggle-double" onclick="toggleEffect('double')">üî≤ Double Stroke</div>
        <div class="toggle-btn" id="toggle-gradient" onclick="toggleEffect('gradient')">üé® Gradient</div>
      </div>
      <label class="field-label" id="grad-label" style="display:none">Gradient Color 2</label>
      <div class="color-row" id="grad-color-row" style="display:none">
        <input type="color" id="gradient-color2" value="#ff6600" oninput="updateSelected()">
        <input type="text" value="#ff6600" oninput="document.getElementById('gradient-color2').value=this.value;updateSelected()">
      </div>
    </div>

  </div>

  <!-- CANVAS -->
  <div class="canvas-area">
    <div class="canvas-toolbar">
      <span class="toolbar-label">Canvas:</span>
      <select id="canvas-size" onchange="changeCanvasSize()" style="width:auto;padding:5px 8px">
        <option value="800x600">800 √ó 600</option>
        <option value="1080x1080" selected>1080 √ó 1080 (Instagram)</option>
        <option value="1920x1080">1920 √ó 1080 (HD)</option>
        <option value="1080x1920">1080 √ó 1920 (Story)</option>
        <option value="1200x630">1200 √ó 630 (Facebook)</option>
      </select>
      <span class="toolbar-label" style="margin-left:8px">Zoom:</span>
      <input type="range" id="zoom" min="20" max="150" value="60" oninput="applyZoom(this.value)" style="width:100px;accent-color:var(--accent)">
      <span id="zoom-label" style="font-size:0.72rem;color:var(--muted)">60%</span>
      <span style="margin-left:auto;font-size:0.72rem;color:var(--muted)">üëÜ Click canvas to place text ‚Ä¢ Drag to move ‚Ä¢ Corner to resize</span>
    </div>
    <div class="canvas-wrapper" id="canvas-wrapper">
      <div id="canvas-container">
        <canvas id="base-canvas"></canvas>
        <canvas id="overlay-canvas"></canvas>
        <div id="handles-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div id="preview-panel">
      <div class="section-title" style="padding:14px 14px 0">üëÅ Live Preview</div>
      <div style="padding:0 14px 14px">
        <p class="hint">Click "Preview" to render with all effects applied by the Python backend.</p>
        <img id="preview-img" src="" alt="" style="display:none;width:100%;margin-top:10px;border-radius:8px;border:1px solid var(--border)">
        <div style="margin-top:10px">
          <span class="badge badge-green" id="status-badge">Ready</span>
        </div>
      </div>
    </div>

    <div style="padding:14px;border-top:1px solid var(--border)">
      <div class="section-title">üìê Position</div>
      <label class="field-label">X Position</label>
      <input type="number" id="pos-x" value="100" oninput="updatePosFromInput()">
      <label class="field-label">Y Position</label>
      <input type="number" id="pos-y" value="100" oninput="updatePosFromInput()">
    </div>

    <div style="padding:14px;border-top:1px solid var(--border)">
      <div class="section-title">üí¨ Selected Layer</div>
      <p id="selected-info" style="font-size:0.75rem;color:var(--muted)">None selected</p>
    </div>

    <div style="padding:14px;border-top:1px solid var(--border)">
      <div class="section-title">üè∑ Tips</div>
      <p class="hint">‚Ä¢ Add text layer then click canvas to place it<br>‚Ä¢ Drag text to reposition<br>‚Ä¢ Use zoom slider to zoom in/out<br>‚Ä¢ Preview renders all effects<br>‚Ä¢ Download saves full resolution PNG</p>
    </div>
  </div>
</main>

<div class="loading-overlay" id="loading">
  <div style="text-align:center">
    <div class="spinner"></div>
    <p style="margin-top:12px;font-size:0.85rem;color:var(--muted)">Rendering...</p>
  </div>
</div>

<script>
// ---- STATE ----
let textLayers = [];
let selectedId = null;
let nextId = 1;
let photoData = null;
let canvasW = 1080, canvasH = 1080;
let zoomLevel = 0.6;
let dragging = null, dragOffX = 0, dragOffY = 0;
let resizing = null;
let pendingPlace = false; // place next click on canvas
let lastRendered = null;

const baseCanvas = document.getElementById('base-canvas');
const overlayCanvas = document.getElementById('overlay-canvas');
const bCtx = baseCanvas.getContext('2d');
const oCtx = overlayCanvas.getContext('2d');
const handlesLayer = document.getElementById('handles-layer');
const container = document.getElementById('canvas-container');

function setCanvasSize(){
  baseCanvas.width = canvasW;
  baseCanvas.height = canvasH;
  overlayCanvas.width = canvasW;
  overlayCanvas.height = canvasH;
  handlesLayer.style.width = canvasW+'px';
  handlesLayer.style.height = canvasH+'px';
  applyZoom(zoomLevel*100);
  drawBase();
}

function applyZoom(val){
  zoomLevel = val/100;
  document.getElementById('zoom-label').textContent = Math.round(val)+'%';
  const scale = zoomLevel;
  baseCanvas.style.width = (canvasW*scale)+'px';
  baseCanvas.style.height = (canvasH*scale)+'px';
  overlayCanvas.style.width = (canvasW*scale)+'px';
  overlayCanvas.style.height = (canvasH*scale)+'px';
  handlesLayer.style.width = (canvasW*scale)+'px';
  handlesLayer.style.height = (canvasH*scale)+'px';
  renderHandles();
}

function changeCanvasSize(){
  const val = document.getElementById('canvas-size').value;
  [canvasW, canvasH] = val.split('x').map(Number);
  setCanvasSize();
}

function drawBase(){
  bCtx.clearRect(0,0,canvasW,canvasH);
  if(photoData){
    const img = new Image();
    img.onload = ()=>{ bCtx.drawImage(img,0,0,canvasW,canvasH); drawTextPreview(); };
    img.src = photoData;
  } else {
    bCtx.fillStyle = '#141420';
    bCtx.fillRect(0,0,canvasW,canvasH);
    // grid
    bCtx.strokeStyle = 'rgba(255,255,255,0.04)';
    bCtx.lineWidth=1;
    for(let x=0;x<canvasW;x+=80){bCtx.beginPath();bCtx.moveTo(x,0);bCtx.lineTo(x,canvasH);bCtx.stroke();}
    for(let y=0;y<canvasH;y+=80){bCtx.beginPath();bCtx.moveTo(0,y);bCtx.lineTo(canvasW,y);bCtx.stroke();}
    drawTextPreview();
  }
}

function drawTextPreview(){
  oCtx.clearRect(0,0,canvasW,canvasH);
  // Simple canvas preview (without all effects - effects shown in server preview)
  for(const layer of textLayers){
    oCtx.save();
    oCtx.globalAlpha = layer.opacity;
    const fontSize = layer.fontSize;
    // Try to approximate font
    oCtx.font = `${fontSize}px sans-serif`;
    oCtx.fillStyle = layer.color;
    if(layer.strokeWidth>0){
      oCtx.strokeStyle = layer.strokeColor;
      oCtx.lineWidth = layer.strokeWidth*2;
      oCtx.strokeText(layer.text, layer.x, layer.y+fontSize*0.8);
    }
    oCtx.fillText(layer.text, layer.x, layer.y+fontSize*0.8);
    oCtx.restore();
  }
}

function renderHandles(){
  handlesLayer.innerHTML = '';
  handlesLayer.style.pointerEvents = 'none';
  for(const layer of textLayers){
    const el = document.createElement('div');
    el.className = 'text-handle' + (layer.id===selectedId?' selected':'');
    el.dataset.id = layer.id;
    el.style.left = (layer.x * zoomLevel)+'px';
    el.style.top = (layer.y * zoomLevel)+'px';
    el.style.fontSize = (layer.fontSize * zoomLevel)+'px';
    el.style.color = layer.color;
    el.style.opacity = layer.opacity;
    el.style.pointerEvents = 'all';
    el.style.fontFamily = 'sans-serif';
    el.style.whiteSpace = 'nowrap';
    el.textContent = layer.text;
    el.style.transform = `rotate(${layer.rotation}deg)`;

    // resize handle
    const rh = document.createElement('div');
    rh.className = 'resize-handle';
    rh.dataset.resize = layer.id;
    el.appendChild(rh);

    el.addEventListener('mousedown', onHandleMouseDown);
    rh.addEventListener('mousedown', onResizeMouseDown);

    handlesLayer.appendChild(el);
  }
}

function onHandleMouseDown(e){
  if(e.target.dataset.resize) return;
  e.preventDefault();
  const id = parseInt(e.currentTarget.dataset.id);
  selectLayer(id);
  const layer = textLayers.find(l=>l.id===id);
  if(!layer) return;
  dragging = layer;
  dragOffX = e.clientX - layer.x * zoomLevel;
  dragOffY = e.clientY - layer.y * zoomLevel;
}

function onResizeMouseDown(e){
  e.preventDefault();
  e.stopPropagation();
  const id = parseInt(e.currentTarget.dataset.resize);
  const layer = textLayers.find(l=>l.id===id);
  if(!layer) return;
  resizing = {layer, startX: e.clientX, startFontSize: layer.fontSize};
}

document.addEventListener('mousemove', e=>{
  if(dragging){
    dragging.x = Math.round((e.clientX - dragOffX)/zoomLevel);
    dragging.y = Math.round((e.clientY - dragOffY)/zoomLevel);
    document.getElementById('pos-x').value = dragging.x;
    document.getElementById('pos-y').value = dragging.y;
    renderHandles();
    drawTextPreview();
  }
  if(resizing){
    const dx = e.clientX - resizing.startX;
    const newSize = Math.max(10, Math.round(resizing.startFontSize + dx/zoomLevel*0.5));
    resizing.layer.fontSize = newSize;
    document.getElementById('font-size').value = newSize;
    document.querySelector('#font-size+span').textContent = newSize;
    renderHandles();
    drawTextPreview();
  }
});

document.addEventListener('mouseup', ()=>{ dragging=null; resizing=null; });

// Click on canvas to place text
document.getElementById('canvas-container').addEventListener('click', e=>{
  if(e.target.closest('.text-handle')) return;
  if(!pendingPlace) return;
  const rect = baseCanvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left)/zoomLevel);
  const y = Math.round((e.clientY - rect.top)/zoomLevel);
  if(selectedId){
    const layer = textLayers.find(l=>l.id===selectedId);
    if(layer){ layer.x=x; layer.y=y; renderHandles(); drawTextPreview(); }
  }
  pendingPlace = false;
  document.getElementById('canvas-container').style.cursor='default';
});

// ---- LAYERS ----
function addTextLayer(){
  const text = document.getElementById('new-text').value.trim();
  if(!text){ alert('Please enter some text first!'); return; }
  const layer = {
    id: nextId++,
    text,
    x: 100, y: 100,
    fontSize: parseInt(document.getElementById('font-size').value),
    color: document.getElementById('text-color').value,
    font: document.getElementById('font-select').value,
    strokeWidth: parseInt(document.getElementById('stroke-width').value),
    strokeColor: document.getElementById('stroke-color').value,
    shadow: document.getElementById('toggle-shadow').classList.contains('active'),
    shadowBlur: parseInt(document.getElementById('shadow-blur').value),
    shadowColor: document.getElementById('shadow-color').value,
    shadowX: parseInt(document.getElementById('shadow-x').value),
    shadowY: parseInt(document.getElementById('shadow-y').value),
    opacity: parseInt(document.getElementById('opacity').value)/100,
    rotation: parseInt(document.getElementById('rotation').value),
    glow: document.getElementById('toggle-glow').classList.contains('active'),
    neon: document.getElementById('toggle-neon').classList.contains('active'),
    outlineOnly: document.getElementById('toggle-outline').classList.contains('active'),
    doubleStroke: document.getElementById('toggle-double').classList.contains('active'),
    gradient: document.getElementById('toggle-gradient').classList.contains('active'),
    gradientColor2: document.getElementById('gradient-color2').value,
  };
  textLayers.push(layer);
  selectLayer(layer.id);
  updateLayersList();
  renderHandles();
  drawTextPreview();
  // Enter placement mode
  pendingPlace = true;
  document.getElementById('canvas-container').style.cursor = 'crosshair';
  document.getElementById('status-badge').textContent = 'Click canvas to place text';
  document.getElementById('status-badge').className = 'badge';
  document.getElementById('status-badge').style.background='rgba(78,156,255,0.15)';
  document.getElementById('status-badge').style.color='var(--blue)';
  document.getElementById('status-badge').style.border='1px solid rgba(78,156,255,0.3)';
}

function selectLayer(id){
  selectedId = id;
  const layer = textLayers.find(l=>l.id===id);
  if(!layer) return;
  // Update controls
  document.getElementById('font-size').value = layer.fontSize;
  document.querySelector('#font-size+span').textContent = layer.fontSize;
  document.getElementById('text-color').value = layer.color;
  document.getElementById('text-color-hex').value = layer.color;
  document.getElementById('font-select').value = layer.font;
  document.getElementById('stroke-width').value = layer.strokeWidth;
  document.querySelector('#stroke-width+span').textContent = layer.strokeWidth;
  document.getElementById('stroke-color').value = layer.strokeColor;
  document.getElementById('stroke-color-hex').value = layer.strokeColor;
  document.getElementById('shadow-blur').value = layer.shadowBlur;
  document.querySelector('#shadow-blur+span').textContent = layer.shadowBlur;
  document.getElementById('shadow-color').value = layer.shadowColor;
  document.getElementById('shadow-color-hex').value = layer.shadowColor;
  document.getElementById('shadow-x').value = layer.shadowX;
  document.getElementById('shadow-y').value = layer.shadowY;
  document.getElementById('opacity').value = Math.round(layer.opacity*100);
  document.querySelector('#opacity+span').textContent = Math.round(layer.opacity*100)+'%';
  document.getElementById('rotation').value = layer.rotation;
  document.querySelector('#rotation+span').textContent = layer.rotation+'¬∞';
  document.getElementById('pos-x').value = layer.x;
  document.getElementById('pos-y').value = layer.y;
  document.getElementById('gradient-color2').value = layer.gradientColor2;
  setToggle('shadow', layer.shadow);
  setToggle('glow', layer.glow);
  setToggle('neon', layer.neon);
  setToggle('outline', layer.outlineOnly);
  setToggle('double', layer.doubleStroke);
  setToggle('gradient', layer.gradient);
  document.getElementById('selected-info').textContent = `Layer ${id}: "${layer.text.substring(0,20)}..."`;
  updateLayersList();
  renderHandles();
}

function setToggle(name, val){
  const el = document.getElementById('toggle-'+name);
  if(val) el.classList.add('active'); else el.classList.remove('active');
  if(name==='gradient'){
    document.getElementById('grad-label').style.display = val?'block':'none';
    document.getElementById('grad-color-row').style.display = val?'flex':'none';
  }
}

function toggleEffect(name){
  const el = document.getElementById('toggle-'+name);
  const isActive = el.classList.toggle('active');
  if(name==='gradient'){
    document.getElementById('grad-label').style.display = isActive?'block':'none';
    document.getElementById('grad-color-row').style.display = isActive?'flex':'none';
  }
  updateSelected();
}

function updateSelected(){
  if(!selectedId) return;
  const layer = textLayers.find(l=>l.id===selectedId);
  if(!layer) return;
  layer.fontSize = parseInt(document.getElementById('font-size').value);
  layer.color = document.getElementById('text-color').value;
  layer.font = document.getElementById('font-select').value;
  layer.strokeWidth = parseInt(document.getElementById('stroke-width').value);
  layer.strokeColor = document.getElementById('stroke-color').value;
  layer.shadow = document.getElementById('toggle-shadow').classList.contains('active');
  layer.shadowBlur = parseInt(document.getElementById('shadow-blur').value);
  layer.shadowColor = document.getElementById('shadow-color').value;
  layer.shadowX = parseInt(document.getElementById('shadow-x').value);
  layer.shadowY = parseInt(document.getElementById('shadow-y').value);
  layer.opacity = parseInt(document.getElementById('opacity').value)/100;
  layer.rotation = parseInt(document.getElementById('rotation').value);
  layer.glow = document.getElementById('toggle-glow').classList.contains('active');
  layer.neon = document.getElementById('toggle-neon').classList.contains('active');
  layer.outlineOnly = document.getElementById('toggle-outline').classList.contains('active');
  layer.doubleStroke = document.getElementById('toggle-double').classList.contains('active');
  layer.gradient = document.getElementById('toggle-gradient').classList.contains('active');
  layer.gradientColor2 = document.getElementById('gradient-color2').value;
  renderHandles();
  drawTextPreview();
}

function updatePosFromInput(){
  if(!selectedId) return;
  const layer = textLayers.find(l=>l.id===selectedId);
  if(!layer) return;
  layer.x = parseInt(document.getElementById('pos-x').value)||0;
  layer.y = parseInt(document.getElementById('pos-y').value)||0;
  renderHandles();
  drawTextPreview();
}

function updateLayersList(){
  const list = document.getElementById('layers-list');
  if(textLayers.length===0){
    list.innerHTML = '<p style="font-size:0.75rem;color:var(--muted)">No text layers yet</p>';
    return;
  }
  list.innerHTML = textLayers.map(l=>`
    <div class="layer-item ${l.id===selectedId?'selected':''}" onclick="selectLayer(${l.id})">
      <span style="font-size:1rem">üìù</span>
      <span class="layer-text">${l.text}</span>
      <button class="layer-del" onclick="event.stopPropagation();deleteLayer(${l.id})">‚úï</button>
    </div>
  `).join('');
}

function deleteLayer(id){
  textLayers = textLayers.filter(l=>l.id!==id);
  if(selectedId===id) selectedId=null;
  updateLayersList();
  renderHandles();
  drawTextPreview();
}

// ---- PHOTO ----
function loadPhoto(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    photoData = ev.target.result;
    drawBase();
  };
  reader.readAsDataURL(file);
}

// ---- RENDER ----
async function renderAndPreview(){
  if(textLayers.length===0 && !photoData){ alert('Please upload a photo or add text layers first!'); return; }
  document.getElementById('loading').classList.add('show');
  document.getElementById('status-badge').textContent = 'Rendering...';
  try {
    const resp = await fetch('/render', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        image: photoData,
        texts: textLayers,
        width: canvasW,
        height: canvasH
      })
    });
    const data = await resp.json();
    if(data.error){ alert('Error: '+data.error); return; }
    lastRendered = data.image;
    const img = document.getElementById('preview-img');
    img.src = data.image;
    img.style.display='block';
    document.getElementById('status-badge').textContent = '‚úì Rendered';
    document.getElementById('status-badge').className = 'badge badge-green';
  } catch(e){
    alert('Render failed: '+e.message);
  } finally {
    document.getElementById('loading').classList.remove('show');
  }
}

async function downloadFinal(){
  await renderAndPreview();
  if(!lastRendered) return;
  document.getElementById('loading').classList.add('show');
  try {
    const resp = await fetch('/download', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({image: lastRendered})
    });
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='bangla_typography.png'; a.click();
    URL.revokeObjectURL(url);
  } catch(e){ alert('Download failed: '+e.message); }
  finally { document.getElementById('loading').classList.remove('show'); }
}

function resetCanvas(){
  if(!confirm('Reset everything?')) return;
  textLayers=[]; selectedId=null; photoData=null; lastRendered=null;
  document.getElementById('preview-img').style.display='none';
  updateLayersList(); renderHandles(); drawBase();
}

// ---- INIT ----
setCanvasSize();
document.getElementById('canvas-size').value = '1080x1080';
</script>
</body>
</html>
